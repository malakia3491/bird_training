# ü¶ú Bird Audio Analysis Framework

–≠—Ç–æ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∑–≤—É–∫–æ–≤ –ø—Ç–∏—Ü —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ Deep Learning.

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É **"–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –∑–∞–¥–∞—á"**:
1.  **Classification** ‚Äî –û–±—É—á–µ–Ω–∏–µ —Å —É—á–∏—Ç–µ–ª–µ–º (Baseline).
2.  **SSL (Self-Supervised Learning)** ‚Äî SimCLR, Denoising Autoencoders (DAE), MAE.
3.  **Metric Learning** ‚Äî ArcFace, Triplet Loss, ProtoNet (–¥–ª—è –∑–∞–¥–∞—á Open World).

–°—Ç–µ–∫: **PyTorch Lightning + Hydra + Timm**.

---

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
1. [–ë—ã—Å—Ç—Ä—ã–π –°—Ç–∞—Ä—Ç](#1-–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –§–∞–π–ª–æ–≤–∞—è –°—Ç—Ä—É–∫—Ç—É—Ä–∞](#2-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–∏-—Ñ–∞–π–ª–æ–≤–∞—è-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
3. [–ì–∞–π–¥ –ø–æ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (Hydra)](#3-–≥–∞–π–¥-–ø–æ-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏-hydra)
4. [–ö–∞–∫ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –º–æ–¥—É–ª–∏](#4-–∫–∞–∫-–¥–æ–±–∞–≤–ª—è—Ç—å-–Ω–æ–≤—ã–µ-–º–æ–¥—É–ª–∏)
5. [–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –î–∞–Ω–Ω—ã—Ö](#5-–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞-–¥–∞–Ω–Ω—ã—Ö)

---

## 1. –ë—ã—Å—Ç—Ä—ã–π –°—Ç–∞—Ä—Ç

–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ `uv` (–∏–ª–∏ pip):
```bash
uv sync
```

### –ó–∞–ø—É—Å–∫ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤
–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ ‚Äî **`main.py`**. –í—ã –≤—ã–±–∏—Ä–∞–µ—Ç–µ –∑–∞–¥–∞—á—É (`task`) –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.

**1. –û–±—ã—á–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è (Baseline):**
```bash
python main.py task=classification experiment_name=Baselines run_name=EfficientNet_B0
```

**2. SSL Pre-training (SimCLR):**
```bash
python main.py task=ssl_contrastive model=panns experiment_name=SSL run_name=SimCLR_PANNs
```

**3. Metric Learning (ArcFace):**
```bash
python main.py task=metric_learning head=arcface loss=cross_entropy
```

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –§–∞–π–ª–æ–≤–∞—è –°—Ç—Ä—É–∫—Ç—É—Ä–∞

–ü—Ä–æ–µ–∫—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω –Ω–∞ **–õ–æ–≥–∏–∫—É (Python)** –∏ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (YAML Configs)**.

### üìÅ `src/` ‚Äî –ö–æ–¥ (–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã)
–ó–¥–µ—Å—å –ª–µ–∂–∞—Ç –∫–ª–∞—Å—Å—ã ("–º–æ–ª–æ—Ç–∫–∏ –∏ –ø–∏–ª—ã"). –û–Ω–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –∑–Ω–∞—é—Ç –æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö –∑–∞–ø—É—Å–∫–∞, –æ–Ω–∏ –ø—Ä–æ—Å—Ç–æ –≤—ã–ø–æ–ª–Ω—è—é—Ç —Ä–∞–±–æ—Ç—É.

*   **`src/systems/`** ‚Äî **LightningModules**. –°–≤—è–∑—ã–≤–∞—é—Ç –º–æ–¥–µ–ª—å, –ª–æ—Å—Å –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä.
    *   `classification.py` ‚Äî –û–±—ã—á–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ.
    *   `ssl.py` ‚Äî –õ–æ–≥–∏–∫–∞ –¥–ª—è SimCLR/DAE (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø–∞—Ä–∞–º–∏ –∫–∞—Ä—Ç–∏–Ω–æ–∫).
    *   `metric.py` ‚Äî –õ–æ–≥–∏–∫–∞ –¥–ª—è ArcFace/ProtoNet (–ø–µ—Ä–µ–¥–∞–µ—Ç labels –≤ Head).
*   **`src/modules/`** ‚Äî –ù–µ–π—Ä–æ—Å–µ—Ç–µ–≤—ã–µ –±–ª–æ–∫–∏.
    *   `models/` ‚Äî –ë—ç–∫–±–æ–Ω—ã (PANNs, EfficientNet).
    *   `heads/` ‚Äî –ì–æ–ª–æ–≤—ã (Linear, Projection, ArcFace).
    *   `decoders/` ‚Äî –î–µ–∫–æ–¥–µ—Ä—ã –¥–ª—è DAE.
*   **`src/data_loaders/`** ‚Äî –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö, –∞—É–≥–º–µ–Ω—Ç–∞—Ü–∏–∏, —Å—ç–º–ø–ª–µ—Ä—ã.

### üìÅ `configs/` ‚Äî –ö–æ–Ω—Ñ–∏–≥–∏ (–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)
–ó–¥–µ—Å—å –º—ã –≥–æ–≤–æ—Ä–∏–º, –∫–∞–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤–∑—è—Ç—å –∏ –∫–∞–∫ –∏—Ö –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å.

*   **`config.yaml`** ‚Äî –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞. –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å—ë –≤–æ–µ–¥–∏–Ω–æ.
*   **`task/`** ‚Äî –ì–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–æ–π –∫–ª–∞—Å—Å `System` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å.
*   **`experiment/`** ‚Äî "–ü—Ä–µ—Å–µ—Ç—ã" –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –Ω–∞—É—á–Ω—ã—Ö –≥–∏–ø–æ—Ç–µ–∑.

---

## 3. –ì–∞–π–¥ –ø–æ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (Hydra)

–°–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ **Dependency Injection**. –í –∫–æ–Ω—Ñ–∏–≥–µ –º—ã –ø–∏—à–µ–º `_target_`, —É–∫–∞–∑—ã–≤–∞—è –ø—É—Ç—å –∫ Python-–∫–ª–∞—Å—Å—É, –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –µ–≥–æ `__init__`.

### –ö–∞–∫ —á–∏—Ç–∞—Ç—å –∏ –º–µ–Ω—è—Ç—å –∫–æ–Ω—Ñ–∏–≥–∏?

#### 1. –í—ã–±–æ—Ä –ó–∞–¥–∞—á–∏ (`configs/task/*.yaml`)
–§–∞–π–ª –∑–∞–¥–∞—á–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–∞—è **–°–∏—Å—Ç–µ–º–∞** –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω–∞ –∏ –∫–∞–∫–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –µ–π –Ω—É–∂–Ω—ã.

*–ü—Ä–∏–º–µ—Ä `configs/task/ssl_contrastive.yaml`:*
```yaml
# –ö–∞–∫–æ–π Python –∫–ª–∞—Å—Å –∑–∞–ø—É—Å—Ç–∏—Ç—å
system_class:
  _target_: src.systems.ssl.SSLSystem
  ssl_mode: contrastive

# –ö–∞–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ–¥—Ç—è–Ω—É—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
defaults:
  - /loss@_global_.loss: ntxent        # Loss –¥–ª—è SimCLR
  - /head@_global_.head: projection    # –ü—Ä–æ–µ–∫—Ç–æ—Ä –≤–º–µ—Å—Ç–æ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞
  - /augmentation@_global_.data.train_transform: contrastive_strong
```

#### 2. –ú–æ–¥–µ–ª—å (`configs/model/*.yaml`)
–û–ø–∏—Å—ã–≤–∞–µ—Ç Backbone (—ç–Ω–∫–æ–¥–µ—Ä).

*–ü—Ä–∏–º–µ—Ä `configs/model/efficientnet.yaml`:*
```yaml
_target_: src.modules.models.audio_backbone.AudioBackbone
name: tf_efficientnet_b0_ns
pretrained: true
checkpoint_path: null  # –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ .pth –æ—Ç SSL
```

#### 3. –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã (`configs/experiment/*.yaml`)
–ß—Ç–æ–±—ã –Ω–µ –ø–∏—Å–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –≤ –∫–æ–Ω—Å–æ–ª–∏, —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —É–¥–∞—á–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å—é–¥–∞.

*–ü—Ä–∏–º–µ—Ä `configs/experiment/phase2_simclr.yaml`:*
```yaml
# @package _global_
defaults:
  - override /task: ssl_contrastive
  - override /model: panns
  - override /data: ssl

experiment_name: "Phase2"
run_name: "Best_SimCLR_Run"

optimizer:
  lr: 0.0001
```
–ó–∞–ø—É—Å–∫: `python main.py experiment=phase2_simclr`

---

## 4. –ö–∞–∫ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –º–æ–¥—É–ª–∏

–§—Ä–µ–π–º–≤–æ—Ä–∫ –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è. –í–æ—Ç –∞–ª–≥–æ—Ä–∏—Ç–º –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–¥–∞—á.

### –°—Ü–µ–Ω–∞—Ä–∏–π –ê: –•–æ—á—É –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –º–æ–¥–µ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, AST)

1.  **Python:** –°–æ–∑–¥–∞–π (–∏–ª–∏ –Ω–∞–π–¥–∏) –∫–ª–∞—Å—Å –º–æ–¥–µ–ª–∏ –≤ `src/modules/models/ast.py`. –û–Ω –¥–æ–ª–∂–µ–Ω –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å `nn.Module` –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –≤–µ–∫—Ç–æ—Ä –ø—Ä–∏–∑–Ω–∞–∫–æ–≤.
2.  **Config:** –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `configs/model/ast.yaml`:
    ```yaml
    _target_: src.modules.models.ast.ASTBackbone
    pretrained: true
    input_fdim: 128
    ```
3.  **–ó–∞–ø—É—Å–∫:** `python main.py model=ast ...`

### –°—Ü–µ–Ω–∞—Ä–∏–π –ë: –•–æ—á—É –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–æ—Ç–µ—Ä—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, Focal Loss)

1.  **Python:** –°–æ–∑–¥–∞–π –∫–ª–∞—Å—Å –≤ `src/utils/losses.py` (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –≥–æ—Ç–æ–≤—ã–π –∏–∑ torch).
2.  **Config:** –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `configs/loss/focal.yaml`:
    ```yaml
    _target_: src.utils.losses.FocalLoss
    gamma: 2.0
    ```
3.  **–ó–∞–ø—É—Å–∫:** `python main.py loss=focal ...`

### –°—Ü–µ–Ω–∞—Ä–∏–π –í: –•–æ—á—É –Ω–æ–≤—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –æ–±—É—á–µ–Ω–∏—è (–ù–æ–≤—ã–π Task)

1.  **Python:** –°–æ–∑–¥–∞–π `src/systems/my_new_task.py`. –ù–∞—Å–ª–µ–¥—É–π—Å—è –æ—Ç `BaseAudioSystem` –∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏ `training_step`.
2.  **Config:** –°–æ–∑–¥–∞–π `configs/task/my_task.yaml`:
    ```yaml
    system_class:
      _target_: src.systems.my_new_task.MySystem
    defaults:
      - /loss@_global_.loss: my_loss
    ```
3.  **–ó–∞–ø—É—Å–∫:** `python main.py task=my_task ...`

---

## 5. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –î–∞–Ω–Ω—ã—Ö

–í –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–≤–∞ —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö:
1.  **–ê—É–¥–∏–æ:** –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã (`.ogg`, `.mp3`).
2.  **–°–ø–µ–∫—Ç—Ä–æ–≥—Ä–∞–º–º—ã:** –ü—Ä–µ–¥–≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (`.npy`) ‚Äî **–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –æ–±—É—á–µ–Ω–∏—è**.

### –°–∫—Ä–∏–ø—Ç—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ (`scripts/data/`)

*   **`prepare_ssl_data_csv.py`**:
    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∞—É–¥–∏–æ –≤ `.npy` —Å–ø–µ–∫—Ç—Ä–æ–≥—Ä–∞–º–º—ã, –∏—Å–ø–æ–ª—å–∑—É—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ CSV.
    ```bash
    python scripts/data/prepare_ssl_data_csv.py \
      --metadata_csv "meta.csv" \
      --audio_root "audio/" \
      --output_dir "processed_data/"
    ```

*   **`merge_datasets.py`**:
    –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤ –≤ –æ–¥–∏–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, BirdCLEF + XenoCanto).

### –í–∞–∂–Ω–æ –ø—Ä–æ LabelEncoder
–ü—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ (`task=classification` –∏–ª–∏ `metric`) —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª `label_encoder.pkl` –≤ –ø–∞–ø–∫–µ —Å –¥–∞–Ω–Ω—ã–º–∏.
*   –ï—Å–ª–∏ –≤—ã –¥–æ–±–∞–≤–ª—è–µ—Ç–µ –Ω–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã –≤ –¥–∞–Ω–Ω—ã–µ, **—É–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–π `label_encoder.pkl`**, —á—Ç–æ–±—ã –æ–Ω –ø–µ—Ä–µ—Å–æ–∑–¥–∞–ª—Å—è.
*   –ü—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ (`test_all_splits.py`) —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ—Ç –∂–µ `label_encoder.pkl`, —á—Ç–æ –∏ –ø—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏.