import os
import pytorch_lightning as pl
from datetime import datetime
import matplotlib.pyplot as plt
from omegaconf import OmegaConf

class SSLExperimentReporter(pl.Callback):
    def __init__(self, cfg, output_dir):
        self.cfg = cfg
        self.output_dir = output_dir
        self.report_path = os.path.join(output_dir, "SSL_REPORT.md")
        
        # –ò—Å—Ç–æ—Ä–∏—è –º–µ—Ç—Ä–∏–∫
        self.history = {
            "epoch": [],
            "train_ssl_loss": [],
            "val_ssl_loss": []
        }

    def on_train_epoch_end(self, trainer, pl_module):
        metrics = trainer.callback_metrics
        epoch = trainer.current_epoch
        
        def get_val(key):
            val = metrics.get(key, None)
            return val.item() if val is not None else None

        self.history["epoch"].append(epoch)
        self.history["train_ssl_loss"].append(get_val("train_ssl_loss"))
        self.history["val_ssl_loss"].append(get_val("val_ssl_loss"))

    def _plot_loss_curve(self):
        epochs = self.history["epoch"]
        if not epochs: return None

        train_loss = self.history["train_ssl_loss"]
        val_loss = self.history["val_ssl_loss"]

        plt.figure(figsize=(10, 6))
        
        # –†–∏—Å—É–µ–º Train
        # –§–∏–ª—å—Ç—Ä—É–µ–º None, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –∫–∞–∫–∞—è-—Ç–æ —ç–ø–æ—Ö–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞
        valid_train = [(e, v) for e, v in zip(epochs, train_loss) if v is not None]
        if valid_train:
            plt.plot(*zip(*valid_train), label="Train Contrastive Loss", marker='o', color='blue')

        # –†–∏—Å—É–µ–º Val
        valid_val = [(e, v) for e, v in zip(epochs, val_loss) if v is not None]
        if valid_val:
            plt.plot(*zip(*valid_val), label="Val Contrastive Loss", marker='s', color='orange')

        plt.title(f"SSL Training Dynamics ({self.cfg.project_name})")
        plt.xlabel("Epoch")
        plt.ylabel("NT-Xent Loss")
        plt.legend()
        plt.grid(True, linestyle='--', alpha=0.7)
        
        plot_path = os.path.join(self.output_dir, "ssl_loss_curve.png")
        plt.savefig(plot_path, dpi=100)
        plt.close()
        
        return "ssl_loss_curve.png"

    def on_train_end(self, trainer, pl_module):
        # 1. –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫
        plot_img = self._plot_loss_curve()
        
        # 2. –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        def get_last_valid(lst):
            valid = [x for x in lst if x is not None]
            return valid[-1] if valid else "N/A"

        final_train = get_last_valid(self.history["train_ssl_loss"])
        final_val = get_last_valid(self.history["val_ssl_loss"])

        # –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        def fmt(val):
            return f"{val:.4f}" if isinstance(val, (int, float)) else str(val)

        # 3. –ö–æ–Ω—Ñ–∏–≥ –≤ YAML
        config_yaml = OmegaConf.to_yaml(self.cfg)
        
        # 4. –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
        md_content = f"""# üß† –û—Ç—á–µ—Ç SSL Pre-training: {self.cfg.project_name}

**ID:** `{os.path.basename(self.output_dir)}`  
**–î–∞—Ç–∞:** {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}  
**–ú–æ–¥–µ–ª—å:** `{self.cfg.model.name}`  
**–ê—É–≥–º–µ–Ω—Ç–∞—Ü–∏–∏:** `RandomCrop`, `Time/Freq Mask`, `Gaussian Noise`

## 1. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã (Pre-training)

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ (Final) | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- | :--- |
| **Train Loss** | **{fmt(final_train)}** | –ù–∞—Å–∫–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–æ –º–æ–¥–µ–ª—å —Å–±–ª–∏–∂–∞–µ—Ç –∞—É–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ (–æ–±—É—á–µ–Ω–∏–µ) |
| **Val Loss** | **{fmt(final_val)}** | –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –µ—Å—Ç—å) |

*–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í SSL –Ω–∏–∑–∫–∏–π Loss –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –º–æ–¥–µ–ª—å –Ω–∞—É—á–∏–ª–∞—Å—å –≤—ã—Ç—è–≥–∏–≤–∞—Ç—å –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ (—É—Å—Ç–æ–π—á–∏–≤—ã–µ –∫ —à—É–º—É –∏ –æ–±—Ä–µ–∑–∫–µ).*

## 2. –î–∏–Ω–∞–º–∏–∫–∞ –æ–±—É—á–µ–Ω–∏—è
![Loss Curve]({plot_img})

## 3. –ü–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
<details>
<summary>üîΩ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–æ–Ω—Ñ–∏–≥ (YAML)</summary>

```yaml
{config_yaml}
</details>
Generated by SSLExperimentReporter
"""
        with open(self.report_path, "w", encoding="utf-8") as f:
            f.write(md_content)
            print(f"\nüìù SSL Report saved to: {self.report_path}")
            print(f"üìà Plot saved as: {plot_img}")