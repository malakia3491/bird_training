import os
import pytorch_lightning as pl
from datetime import datetime
import matplotlib.pyplot as plt
from omegaconf import OmegaConf

class SSLExperimentReporter(pl.Callback):
    def __init__(self, cfg, output_dir):
        self.cfg = cfg
        self.output_dir = output_dir
        self.report_path = os.path.join(output_dir, "SSL_REPORT.md")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º –∏ –∫–ª—é—á–∏ –º–µ—Ç—Ä–∏–∫
        self.ssl_mode = cfg.get("ssl_mode", "contrastive") # contrastive / denoising / reconstruction
        self.train_key = f"train_{self.ssl_mode}_loss"
        self.val_key = f"val_{self.ssl_mode}_loss"
        
        # –ò—Å—Ç–æ—Ä–∏—è –º–µ—Ç—Ä–∏–∫
        self.history = {
            "epoch": [],
            "train_loss": [],
            "val_loss": []
        }

    def on_train_epoch_end(self, trainer, pl_module):
        metrics = trainer.callback_metrics
        epoch = trainer.current_epoch
        
        def get_val(key):
            val = metrics.get(key, None)
            return val.item() if val is not None else None

        self.history["epoch"].append(epoch)
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–ª—é—á–∏
        self.history["train_loss"].append(get_val(self.train_key))
        self.history["val_loss"].append(get_val(self.val_key))

    def _plot_loss_curve(self):
        epochs = self.history["epoch"]
        if not epochs: return None

        train_loss = self.history["train_loss"]
        val_loss = self.history["val_loss"]

        plt.figure(figsize=(10, 6))
        
        valid_train = [(e, v) for e, v in zip(epochs, train_loss) if v is not None]
        if valid_train:
            plt.plot(*zip(*valid_train), label=f"Train {self.ssl_mode.capitalize()} Loss", marker='o', color='blue')

        valid_val = [(e, v) for e, v in zip(epochs, val_loss) if v is not None]
        if valid_val:
            plt.plot(*zip(*valid_val), label=f"Val {self.ssl_mode.capitalize()} Loss", marker='s', color='orange')

        plt.title(f"SSL Dynamics ({self.cfg.project_name})")
        plt.xlabel("Epoch")
        
        # –ü–æ–¥–ø–∏—Å—å –æ—Å–∏ Y –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ª–æ—Å—Å–∞
        ylabel = "MSE Loss" if self.ssl_mode in ["denoising", "reconstruction"] else "NT-Xent Loss"
        plt.ylabel(ylabel)
        
        plt.legend()
        plt.grid(True, linestyle='--', alpha=0.7)
        
        plot_path = os.path.join(self.output_dir, "ssl_loss_curve.png")
        plt.savefig(plot_path, dpi=100)
        plt.close()
        
        return "ssl_loss_curve.png"

    def on_train_end(self, trainer, pl_module):
        plot_img = self._plot_loss_curve()
        
        def get_last_valid(lst):
            valid = [x for x in lst if x is not None]
            return valid[-1] if valid else "N/A"

        final_train = get_last_valid(self.history["train_loss"])
        final_val = get_last_valid(self.history["val_loss"])

        def fmt(val):
            return f"{val:.6f}" if isinstance(val, (int, float)) else str(val)

        config_yaml = OmegaConf.to_yaml(self.cfg)
        
        # –û–ø–∏—Å–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏
        loss_desc = "MSE (Reconstruction Error)" if self.ssl_mode != "contrastive" else "Contrastive Similarity"

        md_content = f"""# üß† –û—Ç—á–µ—Ç SSL ({self.ssl_mode}): {self.cfg.project_name}

**ID:** `{os.path.basename(self.output_dir)}`  
**–î–∞—Ç–∞:** {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}  
**–ú–æ–¥–µ–ª—å:** `{self.cfg.model.name}`  
**–†–µ–∂–∏–º:** `{self.ssl_mode}`

## 1. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ (Final) | –ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç |
| :--- | :--- | :--- |
| **Train Loss** | **{fmt(final_train)}** | {loss_desc} –Ω–∞ –æ–±—É—á–µ–Ω–∏–∏ |
| **Val Loss** | **{fmt(final_val)}** | {loss_desc} –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ |

## 2. –î–∏–Ω–∞–º–∏–∫–∞ –æ–±—É—á–µ–Ω–∏—è
![Loss Curve]({plot_img})

## 3. –ü–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
<details>
<summary>üîΩ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–æ–Ω—Ñ–∏–≥ (YAML)</summary>

```yaml
{config_yaml}
</details>
Generated by SSLExperimentReporter v2
"""
        with open(self.report_path, "w", encoding="utf-8") as f:
            f.write(md_content)
            print(f"\nüìù SSL Report saved to: {self.report_path}")